<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#1a2a5e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">
<title>Cotizador de Lote de Inversi√≥n ‚Äî LUNA Grupo Inmobiliario</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #1a2a5e;
    --blue: #2d4aad;
    --blue-mid: #3b5cc4;
    --blue-light: #5b7de0;
    --accent: #e8f0ff;
    --surface: #f4f7ff;
    --white: #ffffff;
    --text: #0f1c3f;
    --text-muted: #5a6a90;
    --border: #d0daf5;
    --green: #00b87a;
    --green-bg: #e6faf4;
    --shadow: 0 4px 24px rgba(26,42,94,0.10);
    --danger: #d93025;
    --danger-bg: #fde8e7;
    --logo-h: 58px;
    --logo-h-mobile: 44px;
    --logo-h-xs: 40px;
    --mark-h: 58px;
    --mark-h-mobile: 44px;
    --mark-h-xs: 40px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Sora', sans-serif; background: #eef2ff; color: var(--text); min-height: 100vh; -webkit-text-size-adjust: 100%; }
  header { 
    background: var(--navy);
    padding: calc(18px + env(safe-area-inset-top)) calc(40px + env(safe-area-inset-right)) 18px calc(40px + env(safe-area-inset-left));
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 20px rgba(0,0,0,0.25);
    position: sticky; top: 0; z-index: 100;
  }
  .logo-wrap { display: flex; align-items: center; gap: 12px; justify-self: start; }
  .header-center-logo { justify-self: center; display: flex; align-items: center; }
  .header-right { justify-self: end; display: flex; align-items: center; justify-content: flex-end; }

  .header-center-logo img { height: var(--mark-h); width: auto; opacity: 0.95; }
  @media (max-width: 768px) { .header-center-logo img { height: var(--mark-h-mobile); } }
  @media (max-width: 420px) { .header-center-logo img { height: var(--mark-h-xs); } .header-badge { display: none; } }
  .logo-svg { display:block; height: var(--logo-h); width: auto; max-width: min(520px, 44vw); }
  .logo-right { display:block; height: var(--logo-h); width:auto; max-width: min(520px, 44vw); }

  .logo-fallback { display:none; color:#fff; font-weight:700; letter-spacing:1px; font-size:16px; }
  .header-badge { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; padding: 6px 16px; color: #fff; font-size: 12px; font-weight: 500; letter-spacing: 1px;  justify-self: end; }
  main { max-width: 1100px; margin: 0 auto; padding: 36px calc(24px + env(safe-area-inset-right)) 60px calc(24px + env(safe-area-inset-left)); }
  .page-title { text-align: center; margin-bottom: 36px; }
  .page-title h1 { font-size: 28px; font-weight: 700; color: var(--navy); }
  .page-title p { color: var(--text-muted); font-size: 14px; margin-top: 6px; }
  .card { background: var(--white); border-radius: 18px; padding: 30px 32px; box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid rgba(208,218,245,0.5); }
  .card-title { font-size: 13px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--blue-mid); margin-bottom: 22px; display: flex; align-items: center; gap: 8px; }
  .card-title::before { content: ''; display: inline-block; width: 4px; height: 18px; background: var(--blue-mid); border-radius: 2px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
  .stack { display: flex; flex-direction: column; gap: 20px; }
  @media (max-width: 768px) {
    .grid-2, .grid-3 { grid-template-columns: 1fr; }
    header {
      padding: calc(12px + env(safe-area-inset-top)) calc(16px + env(safe-area-inset-right)) 12px calc(16px + env(safe-area-inset-left));
    }
    .logo-svg { height: var(--logo-h-mobile); max-width: 220px; }
  .logo-right { height: var(--logo-h-mobile); max-width: 220px; }
    .header-badge { font-size: 11px; padding: 5px 12px; }
    main { padding: 24px 16px 50px; }
    .card { padding: 22px 20px; }
  }

  @media (max-width: 420px) {
    .logo-svg { height: var(--logo-h-xs); max-width: 200px; }
  .logo-right { height: var(--logo-h-xs); max-width: 200px; }
    .header-badge { display: none; }
  }
  .field { display: flex; flex-direction: column; gap: 7px; }
  label { font-size: 12px; font-weight: 600; color: var(--text-muted); letter-spacing: 0.5px; text-transform: uppercase; }
  input[type="text"], input[type="number"], input[type="date"], select { border: 1.5px solid var(--border); border-radius: 10px; padding: 11px 14px; font-family: 'Sora', sans-serif; font-size: 14px; color: var(--text); background: var(--white); transition: border-color 0.2s, box-shadow 0.2s; outline: none; width: 100%; }
  input:focus, select:focus { border-color: var(--blue-mid); box-shadow: 0 0 0 3px rgba(45,74,173,0.10); }
  .calc-field { border: 1.5px solid var(--accent); border-radius: 10px; padding: 11px 14px; font-family: 'DM Mono', monospace; font-size: 14px; font-weight: 500; color: var(--navy); background: var(--surface); cursor: not-allowed; width: 100%; }
  .summary-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 16px; }
  @media (max-width: 768px) { .summary-row { grid-template-columns: 1fr 1fr; } }
  .summary-card { background: var(--navy); border-radius: 14px; padding: 20px 18px; text-align: center; }
  .summary-card .s-label { font-size: 11px; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; color: rgba(255,255,255,0.55); margin-bottom: 8px; }
  .summary-card .s-value { font-family: 'DM Mono', monospace; font-size: 17px; font-weight: 600; color: #fff; }
  .summary-card.accent-green { background: linear-gradient(135deg, #00a36c, #00cc88); }
  .summary-card.accent-blue { background: linear-gradient(135deg, var(--blue), var(--blue-light)); }

  .alert { display:none; margin: 0 0 24px; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(217,48,37,0.25); background: var(--danger-bg); color: var(--danger); font-size: 13px; }
  .alert strong { font-weight: 700; }

  .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 12px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead th { background: var(--navy); color: #fff; padding: 12px 16px; text-align: left; font-weight: 600; font-size: 11px; letter-spacing: 1px; text-transform: uppercase; white-space: nowrap; }
  tbody tr:nth-child(even) { background: var(--surface); }
  tbody tr:hover { background: var(--accent); }
  tbody td { padding: 10px 16px; border-bottom: 1px solid var(--border); font-family: 'DM Mono', monospace; font-size: 12.5px; color: var(--text); white-space: nowrap; }
  tbody td:first-child { font-family: 'Sora', sans-serif; font-weight: 600; color: var(--navy); }
  .row-special td { background: linear-gradient(90deg, rgba(45,74,173,0.07), transparent); font-weight: 600; color: var(--blue); }
  .btn-row { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; }
  .btn { border: none; border-radius: 10px; padding: 12px 28px; font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
  .btn-primary { background: var(--navy); color: #fff; box-shadow: 0 4px 14px rgba(26,42,94,0.3); }
  .btn-primary:hover { background: var(--blue); transform: translateY(-1px); }
  .btn-outline { background: transparent; color: var(--navy); border: 1.5px solid var(--navy); }
  .btn-outline:hover { background: var(--accent); }
  .divider { height: 1px; background: var(--border); margin: 24px 0; }
  .info-note { background: var(--accent); border-left: 3px solid var(--blue-mid); border-radius: 0 8px 8px 0; padding: 10px 16px; font-size: 12px; color: var(--text-muted); margin-top: 12px; }

  .inapp-banner{
    max-width:1100px;
    margin: 10px auto 0;
    padding: 10px 14px;
    border-radius: 12px;
    background: rgba(255, 194, 15, 0.18);
    border: 1px solid rgba(255, 194, 15, 0.45);
    color: var(--text);
    font-size: 12.5px;
    line-height: 1.35;
  }


  @media print {
    @page { size: A4; margin: 15mm 12mm; }
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    
    /* Print: mostrar solo Cliente/Asesor + Amortizaci√≥n + Legal */
    header, .page-title, .summary-row, .fx-sub, .fx-row, #mxnEq, #alertInconsistencia { display: none !important; }
    main > * { display: none !important; }
    main > .print-keep { display: block !important; }

    /* Permitir que la tabla se parta en p√°ginas sin dejar ‚Äúcuadros‚Äù en blanco */
    .card.print-splittable { break-inside: auto !important; page-break-inside: auto !important; }
    .table-wrapper { overflow: visible !important; }

    table { page-break-inside: auto; }
    thead { display: table-header-group; }
    tr { break-inside: avoid; page-break-inside: avoid; }
header { position: relative !important; }
    .btn-row { display: none !important; }
    body { background: white !important; }
    main { padding: 0 !important; max-width: 100% !important; }
    .card { box-shadow: none !important; border: 1px solid #ccc !important; margin-bottom: 12px !important; padding: 16px !important; break-inside: avoid; page-break-inside: avoid; }
    .summary-card { border: 1px solid #999 !important; }
    .summary-card.accent-green { background: #00b87a !important; }
    .summary-card.accent-blue { background: #2d4aad !important; }
    .summary-card .s-label { color: rgba(255,255,255,0.75) !important; font-size: 9px !important; }
    .summary-card .s-value { color: #fff !important; font-size: 14px !important; }
    thead th { background: #1a2a5e !important; color: #fff !important; }
    .info-note { display: none; }
    .alert { display:none !important; }
    input, .calc-field { border: 1px solid #ccc !important; padding: 4px 8px !important; font-size: 11px !important; }
    label { font-size: 9px !important; }
    tbody td { font-size: 10px !important; padding: 6px 10px !important; }
    .logo-svg { height: 40px !important; max-width: 240px !important; }
    header { padding: 12px 20px !important; }
  }

  .fx-row { display: flex; gap: 10px; align-items: center; }
  .fx-row input[type="number"] { flex: 1; }
  .btn-mini { padding: 10px 14px; font-size: 12px; border-radius: 10px; white-space: nowrap; }
  .fx-sub { margin-top: 8px; font-size: 12px; color: var(--text-muted); display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
  .fx-sub a { color: var(--blue-mid); text-decoration: none; font-weight: 600; }
  .fx-sub a:hover { text-decoration: underline; }
  .fx-status { color: var(--text-muted); opacity: 0.9; }
  .footer-legal { margin-top: 22px; background: var(--white); border: 1px solid rgba(208,218,245,0.5); box-shadow: var(--shadow); border-radius: 18px; padding: 18px 22px; }
  .legal-title { font-size: 12px; font-weight: 700; letter-spacing: 1.3px; text-transform: uppercase; color: var(--blue-mid); margin-bottom: 10px; }
  .legal-body { font-size: 12.5px; line-height: 1.55; color: var(--text-muted); }
  .legal-body p { margin: 8px 0; }


  /* Mobile/iOS UX: evita zoom al enfocar inputs y mejora targets t√°ctiles */
  @media (max-width: 768px) {
    input[type="text"], input[type="number"], input[type="date"], select { font-size: 16px; }
    .btn { padding: 14px 18px; }
    .btn-row { flex-direction: column; align-items: stretch; }
    header { padding: calc(14px + env(safe-area-inset-top)) calc(20px + env(safe-area-inset-right)) 14px calc(20px + env(safe-area-inset-left)); }
    main { padding: 24px calc(16px + env(safe-area-inset-right)) 50px calc(16px + env(safe-area-inset-left)); }
  }

  /* Dispositivos t√°ctiles (Android/iOS/iPadOS): evita zoom al enfocar */
  @media (hover: none) and (pointer: coarse) {
    input[type="text"], input[type="number"], input[type="date"], select { font-size: 16px; }
  }

</style>
</head>
<body>

<header>
  <div class="logo-wrap">
    <!-- Logo: LUNA Grupo Inmobiliario -->
    <img src="assets/logo_luna.png" class="logo-svg" alt="LUNA Grupo Inmobiliario"
         onerror="this.style.display='none'; document.getElementById('logoFallback').style.display='block';" />
    <span class="logo-fallback" id="logoFallback">LUNA Grupo Inmobiliario</span>
  </div>

  <div class="header-center-logo" aria-label="Marca LUNA">
    <img src="assets/logo_luna_moon.png" alt="LUNA" />
  </div>

  <div class="header-right">
    <img src="assets/logo_jessica_lorzo.png" class="logo-right" alt="Jessica Lorzo ‚Äî Ra√≠ces y Sue√±os" />
  </div>
</header>

<div id="inAppBanner" class="inapp-banner" style="display:none;">
  ‚ö†Ô∏è Est√°s abriendo el cotizador dentro de una app. Para que <strong>Imprimir / Guardar PDF</strong> funcione bien, toca el men√∫ de la app y elige <strong>‚ÄúAbrir en navegador‚Äù</strong> (Safari / Chrome).
</div>

<main>
  <div class="page-title">
    <h1>Cotizador de Lote de Inversi√≥n</h1>
    <p>Complete los datos del cliente y configuraci√≥n del financiamiento para generar la tabla de amortizaci√≥n</p>
  </div>

  <div class="card print-keep" id="cardCliente">
    <div class="card-title">Informaci√≥n del Cliente y Asesor</div>
    <div class="grid-2">
      <div class="stack">
        <div class="field">
          <label>Nombre del Inversionista</label>
          <input type="text" id="nombreInversionista" placeholder="Ej. Mar√≠a Gonz√°lez L√≥pez">
        </div>
        <div class="field">
          <label>Nombre del Proyecto</label>
          <input type="text" id="nombreProyecto" placeholder="Ej. Residencial Alura">
        </div>
      </div>
      <div class="field">
        <label>Nombre del Asesor</label>
        <input type="text" id="nombreAsesor" placeholder="Ej. Carlos Mart√≠nez">
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">Par√°metros del Financiamiento</div>
    <div class="grid-3">
      <div class="field">
        <label>Moneda</label>
        <select id="moneda" onchange="setMoneda(this.value)">
          <option value="MXN" selected>MXN ‚Äî Pesos</option>
          <option value="USD">USD ‚Äî D√≥lares</option>
        </select>
      </div>
      <div class="field" id="fxField" style="display:none;">
        <label>Tipo de cambio USD‚ÜíMXN (Google)</label>
        <div class="fx-row">
          <input type="number" id="tipoCambio" min="0" step="0.0001" value="" placeholder="Ej. 17.2500" oninput="calcular()" onchange="calcular()">
          <button type="button" class="btn btn-outline btn-mini" onclick="actualizarTipoCambio(true)">Actualizar</button>
        </div>
        <div class="fx-sub">
          Referencia: <a href="https://www.google.com/finance/quote/USD-MXN" target="_blank" rel="noopener">Google Finance USD/MXN</a>
          <span class="fx-status" id="tcStatus"></span>
        </div>
      </div>

      <div class="field">
        <label>Precio de la Propiedad</label>
        <input type="text" id="precio" value="440000" inputmode="decimal" autocomplete="off" onfocus="unformatMoney('precio')" onblur="formatMoney('precio'); calcular()" oninput="calcular()" onchange="calcular()">
      </div>
      <div class="field">
        <label>Apartado</label>
        <input type="text" id="apartado" value="5000" inputmode="decimal" autocomplete="off" onfocus="unformatMoney('apartado')" onblur="formatMoney('apartado'); calcular()" oninput="calcular()" onchange="calcular()">
      </div>
      <div class="field">
        <label>% Enganche</label>
        <input type="number" id="tasaEnganche" value="20" min="0" max="100" step="1" oninput="calcular()" onchange="calcular()">
      </div>
      <div class="field">
        <label>Tasa de Inter√©s Anual (%)</label>
        <input type="number" id="tasaAnual" value="0" min="0" step="0.1" oninput="calcular()" onchange="calcular()">
      </div>
      <div class="field">
        <label>Plazo (Meses)</label>
        <input type="number" id="plazo" value="20" min="1" max="360" step="1" oninput="calcular()" onchange="calcular()">
      </div>
      <div class="field">
        <label>% Comisi√≥n de Apertura</label>
        <input type="number" id="tasaComision" value="2" min="0" max="10" step="0.5" oninput="calcular()" onchange="calcular()">
      </div>
    </div>

    <div class="divider"></div>

    <div class="grid-3">
      <div class="field">
        <label>Fecha de Reserva</label>
        <input type="date" id="fechaReserva" oninput="calcular()" onchange="calcular()">
      </div>
      <div class="field">
        <label>Fecha de Enganche</label>
        <input type="date" id="fechaEnganche" oninput="calcular()" onchange="calcular()">
      </div>
      <div class="field">
        <label>Fecha 1er Pago</label>
        <input type="date" id="fechaPrimerPago" oninput="calcular()" onchange="calcular()">
      </div>
    </div>

    <div class="divider"></div>

    <div class="grid-3">
      <div class="field">
        <label>Enganche Calculado</label>
        <div class="calc-field" id="engancheCalc">‚Äî</div>
      </div>
      <div class="field">
        <label>Comisi√≥n de Apertura</label>
        <div class="calc-field" id="comisionCalc">‚Äî</div>
      </div>
      <div class="field">
        <label>Monto a Financiar</label>
        <div class="calc-field" id="montoFinanciarCalc">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="summary-row">
    <div class="summary-card">
      <div class="s-label">Precio Propiedad</div>
      <div class="s-value" id="s-precio">‚Äî</div>
    </div>
    <div class="summary-card accent-blue">
      <div class="s-label">Pago Mensual</div>
      <div class="s-value" id="s-mensual">‚Äî</div>
    </div>
    <div class="summary-card">
      <div class="s-label">Total a Pagar</div>
      <div class="s-value" id="s-total">‚Äî</div>
    </div>
    <div class="summary-card accent-green">
      <div class="s-label">Enganche + Apartado</div>
      <div class="s-value" id="s-enganche">‚Äî</div>
    </div>
  </div>

  <div class="alert" id="alertInconsistencia"></div>

  <div class="info-note" id="mxnEq" style="display:none;">
    üí± <strong>Equivalentes en MXN</strong> (TC <span id="tcInline">‚Äî</span>): Precio <strong id="mxnPrecio">‚Äî</strong> ¬∑ Pago mensual <strong id="mxnMensual">‚Äî</strong> ¬∑ Total <strong id="mxnTotal">‚Äî</strong>.
  </div>

  <div class="card print-keep print-splittable" id="cardAmort">
    <div class="card-title">Tabla de Amortizaci√≥n</div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Fecha</th>
            <th>Balance Inicial</th>
            <th>Pago Programado</th>
            <th>Inter√©s</th>
            <th>Capital</th>
            <th>Balance Final</th>
          </tr>
        </thead>
        <tbody id="tbodyAmort"></tbody>
      </table>
    </div>
    <div class="info-note">
      üí° Los campos sombreados son calculados autom√°ticamente. Solo edite los campos de entrada. Los pagos de <strong>Reserva</strong> y <strong>Enganche</strong> no generan intereses.
    </div>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="limpiar()">Limpiar Formulario</button>
      <button class="btn btn-primary" onclick="imprimirPDF()">üñ®Ô∏è Imprimir / Guardar PDF</button>
    </div>
  </div>

  <footer class="footer-legal print-keep" id="footerLegal">
    <div class="legal-title">Privacidad, confidencialidad y vigencia</div>
    <div class="legal-body">
      <p><strong>Privacidad y confidencialidad:</strong> Esta cotizaci√≥n contiene informaci√≥n confidencial. Su uso es exclusivamente para el destinatario y para fines de evaluaci√≥n comercial. Queda prohibida su reproducci√≥n, distribuci√≥n o divulgaci√≥n sin autorizaci√≥n por escrito de LUNA Grupo Inmobiliario.</p>
      <p><strong>Vigencia:</strong> Esta cotizaci√≥n tiene vigencia de <strong>5 d√≠as naturales</strong> a partir de la fecha de emisi√≥n/impresi√≥n. Despu√©s de ese plazo, precios y condiciones pueden cambiar sin previo aviso.</p>
      <p><strong>Apartado:</strong> El pago de <strong>apartado no es reembolsable</strong>. En caso de desistimiento, el apartado se aplicar√° a gastos administrativos y de oportunidad comercial.</p>
    </div>
  </footer>

</main>

<script>
  let moneda = 'MXN';
  const formatters = {
    MXN: new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 }),
    USD: new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }),
  };
  const fmtC = (n, code = moneda) => (n == null || isNaN(n)) ? '‚Äî' : (formatters[code] || formatters.MXN).format(n);
  const fmt = (n) => fmtC(n, moneda);
  const fmtMXN = (n) => fmtC(n, 'MXN');

  const parseMoney = (v) => {
    let s = String(v ?? '').trim();
    if (!s) return 0;

    // Deja solo d√≠gitos, coma, punto y signo menos.
    s = s.replace(/[^0-9,\.\-]/g, '');

    const hasComma = s.includes(',');
    const hasDot = s.includes('.');

    // Caso 1: tiene coma y punto -> asumimos coma como miles (es-MX)
    if (hasComma && hasDot) {
      s = s.replace(/,/g, '');
    }
    // Caso 2: solo coma -> asumimos coma como decimal (teclados iOS)
    else if (hasComma && !hasDot) {
      const parts = s.split(',');
      const dec = parts.pop();
      s = parts.join('') + '.' + dec;
    }

    // Manejo de m√∫ltiples puntos: conserva el √∫ltimo como decimal, el resto como miles
    const neg = s.startsWith('-') ? '-' : '';
    s = s.replace(/-/g, '');
    const dots = s.split('.');
    if (dots.length > 2) {
      const dec = dots.pop();
      s = dots.join('') + '.' + dec;
    }

    const n = parseFloat(neg + s);
    return isNaN(n) ? 0 : n;
  };

  
  function isInAppBrowser() {
    const ua = navigator.userAgent || '';
    return /Instagram|FBAN|FBAV|WhatsApp|Line|TikTok|Twitter|LinkedInApp|Snapchat/i.test(ua);
  }

function formatMoney(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const n = parseMoney(el.value);
    el.value = fmt(n);
  }

  function unformatMoney(id) {
    const el = document.getElementById(id);
    if (!el) return;
    const n = parseMoney(el.value);
    el.value = n ? String(n) : '';
  }

  function setMoneda(code) {
    moneda = (code === 'USD') ? 'USD' : 'MXN';

    // Toggle UI de tipo de cambio
    const fx = document.getElementById('fxField');
    if (fx) fx.style.display = (moneda === 'USD') ? 'block' : 'none';

    // Re-formatea inputs y recalcula todo
    formatMoney('precio');
    formatMoney('apartado');

    // Si es USD, intenta traer TC y si no hay, deja el campo editable
    if (moneda === 'USD') {
      const tc = getNum('tipoCambio');
      if (!tc || tc <= 0) actualizarTipoCambio();
    }

    calcular();
  }

  function setTCStatus(msg) {
    const s = document.getElementById('tcStatus');
    if (s) s.textContent = msg ? `¬∑ ${msg}` : '';
  }

function cacheFX(rate, source) {
    try {
      localStorage.setItem('luna_fx_usdmxn', JSON.stringify({ rate: Number(rate), source: String(source || ''), ts: Date.now() }));
    } catch (_) {}
  }

  function readCachedFX(maxAgeHours = 48) {
    try {
      const raw = localStorage.getItem('luna_fx_usdmxn');
      if (!raw) return null;
      const j = JSON.parse(raw);
      if (!j || !isFinite(j.rate) || j.rate <= 0 || !j.ts) return null;
      const ageH = (Date.now() - Number(j.ts)) / 36e5;
      if (ageH > maxAgeHours) return null;
      return j;
    } catch (_) { return null; }
  }

  function fmtStamp(ts) {
    try {
      const d = new Date(ts);
      return d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' +
             d.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
    } catch (_) { return ''; }
  }

  
  function getTC() {
    if (moneda !== 'USD') return 1;
    const tc = getNum('tipoCambio');
    return (tc && tc > 0) ? tc : 0;
  }

  async function fetchWithTimeout(url, options = {}, timeoutMs = 6500) {
    const ctrl = new AbortController();
    const id = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      return await fetch(url, { ...options, signal: ctrl.signal });
    } finally {
      clearTimeout(id);
    }
  }

  async function actualizarTipoCambio(force = false) {
    if (moneda !== 'USD') return;

    const now = new Date();
    const stamp =
      now.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' }) +
      ' ' +
      now.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });

    const el = document.getElementById('tipoCambio');
    const existing = getNum('tipoCambio');

    if (!force && existing && existing > 0) {
      setTCStatus('Usando el valor capturado');
      calcular();
      return;
    }

    setTCStatus('Consultando‚Ä¶');

    // 1) Intento: Google Finance (v√≠a proxy de solo lectura con CORS)
    try {
      const url = 'https://r.jina.ai/https://www.google.com/finance/quote/USD-MXN';
      const res = await fetchWithTimeout(url, { cache: 'no-store' }, 6500);
      const t = await res.text();

      // Intento 1: precio en div YMlKec fxKbKc
      let m = t.match(/YMlKec\s+fxKbKc[^>]*>([0-9.,]+)/);
      // Intento 2: data-last-price
      if (!m) m = t.match(/data-last-price="([0-9.]+)"/);
      // Intento 3: fallback gen√©rico cercano a "USD/MXN"
      if (!m) m = t.match(/\bUSD\s*[-/ ]\s*MXN\b[\s\S]{0,500}?([0-9]{1,3}(?:,[0-9]{3})*(?:\.[0-9]+)?)/i);

      if (!m) throw new Error('No se encontr√≥ el tipo de cambio en Google Finance.');
      const rate = parseFloat(String(m[1]).replace(/,/g, ''));
      if (!isFinite(rate) || rate <= 0) throw new Error('Tipo de cambio inv√°lido.');

      if (el) el.value = rate.toFixed(4);
      cacheFX(rate, 'google');
      setTCStatus(`Fuente: Google Finance ¬∑ ${stamp}`);
      calcular();
      return;
    } catch (e) {
      console.warn('Google Finance no disponible:', e);
    }

    // 2) Fallback: API con CORS (para que no se ‚Äúmuera‚Äù en m√≥vil/webview)
    try {
      const api = 'https://api.frankfurter.app/latest?from=USD&to=MXN';
      const res = await fetchWithTimeout(api, { cache: 'no-store' }, 6500);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const j = await res.json();
      const rate = j && j.rates && j.rates.MXN ? Number(j.rates.MXN) : 0;
      if (!isFinite(rate) || rate <= 0) throw new Error('Tipo de cambio inv√°lido.');

      if (el) el.value = rate.toFixed(4);
      cacheFX(rate, 'api');
      setTCStatus(`Fuente: tasa interbancaria (API) ¬∑ ${stamp}`);
      calcular();
      return;
    } catch (e2) {
      console.warn('FX fallback no disponible:', e2);
      const cached = readCachedFX(96);
      if (cached && el) {
        el.value = Number(cached.rate).toFixed(4);
        setTCStatus(`Usando √∫ltimo guardado (${cached.source || 'cache'}) ¬∑ ${fmtStamp(cached.ts)}`);
        calcular();
      } else {
        setTCStatus('No disponible (ingr√©salo manual)');
      }
    }
  }


  const fmtDate = (iso) => {
    if (!iso) return '‚Äî';
    const d = new Date(iso + 'T12:00:00');
    return d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  // Month add "EOM-safe" (evita brincos tipo 31-ene -> 03-mar)
  const addMonths = (iso, months) => {
    if (!iso) return '';
    const base = new Date(iso + 'T12:00:00');
    const day = base.getDate();

    const d = new Date(base);
    d.setDate(1);
    d.setMonth(d.getMonth() + months);

    const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
    d.setDate(Math.min(day, lastDay));

    return d.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
  };

  function get(id) { const el = document.getElementById(id); return el ? el.value : ''; }
  function getNum(id) { return parseMoney(get(id)); }

  function initFechas() {
    const hoy = new Date();

    const toInputDate = (d) => {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    };

    const manana = new Date(hoy); manana.setDate(hoy.getDate() + 1);
    const sigSemana = new Date(hoy); sigSemana.setDate(hoy.getDate() + 7);

    document.getElementById('fechaReserva').value = toInputDate(hoy);
    document.getElementById('fechaEnganche').value = toInputDate(manana);
    document.getElementById('fechaPrimerPago').value = toInputDate(sigSemana);
  }

  function calcular() {
    // Inputs (con clamps para evitar negativos raros)
    const precio = Math.max(0, getNum('precio'));
    const apartadoRaw = Math.max(0, getNum('apartado'));
    const apartado = Math.min(apartadoRaw, precio); // el apartado no deber√≠a exceder el precio
    const pctEnganche = Math.min(1, Math.max(0, getNum('tasaEnganche') / 100));
    const tasaAnual = Math.max(0, getNum('tasaAnual') / 100);
    const plazo = Math.max(1, Math.round(getNum('plazo')));
    const pctComision = Math.max(0, getNum('tasaComision') / 100);

    const enganche = precio * pctEnganche;

    // Comisi√≥n sobre saldo financiable (no sobre el total ya apartado/enganche)
    const saldoBase = Math.max(0, precio - apartado - enganche);
    const comision = saldoBase * pctComision;

    // Comisi√≥n FINANCIADA: forma parte del monto a financiar
    const montoFinanciar = saldoBase + comision;

    document.getElementById('engancheCalc').textContent = fmt(enganche);
    document.getElementById('comisionCalc').textContent = fmt(comision);
    document.getElementById('montoFinanciarCalc').textContent = fmt(montoFinanciar);

    const tasaMensual = tasaAnual / 12;

    // Pago mensual (amortizaci√≥n cl√°sica). Si tasa = 0, pago lineal.
    const pagoMensual = (tasaMensual === 0)
      ? (montoFinanciar / plazo)
      : (montoFinanciar * tasaMensual) / (1 - Math.pow(1 + tasaMensual, -plazo));

    document.getElementById('s-precio').textContent = fmt(precio);
    document.getElementById('s-mensual').textContent = fmt(pagoMensual);

    // Armado de tabla (y de paso: total real seg√∫n tabla, no f√≥rmula ‚Äúa ojo‚Äù)
    const tbody = document.getElementById('tbodyAmort');
    tbody.innerHTML = '';

    let totalPagos = 0;

    // Reserva (sin inter√©s)
    const balInit = precio + comision;
    const balFin = Math.max(0, balInit - apartado);
    totalPagos += apartado;
    tbody.appendChild(buildRow('Reserva', fmtDate(get('fechaReserva')), balInit, apartado, '‚Äî', apartado, balFin, true));

    // Enganche (sin inter√©s)
    const balInit2 = balFin;
    const balFin2 = Math.max(0, balInit2 - enganche);
    totalPagos += enganche;
    tbody.appendChild(buildRow('Enganche', fmtDate(get('fechaEnganche')), balInit2, enganche, '‚Äî', enganche, balFin2, true));

    // Mensualidades
    let balance = montoFinanciar;
    for (let i = 1; i <= plazo; i++) {
      const fecha = addMonths(get('fechaPrimerPago'), i - 1);
      const interes = balance * tasaMensual;

      let pago, capital;
      if (i === plazo) {
        // cierre exacto (evita centavos ‚Äúfantasma‚Äù)
        pago = (tasaMensual === 0) ? balance : (balance + interes);
        capital = balance;
        balance = 0;
      } else {
        pago = pagoMensual;
        capital = pago - interes;
        balance = Math.max(0, balance - capital);
      }

      totalPagos += pago;
      tbody.appendChild(buildRow(
        i,
        fecha,
        balance + capital,
        pago,
        interes,
        capital,
        balance,
        false
      ));
    }

    // Total a pagar: suma real de pagos mostrados (ya no hay doble conteo)
    document.getElementById('s-total').textContent = fmt(totalPagos);
    document.getElementById('s-enganche').textContent = fmt(apartado + enganche);

    // Equivalentes en MXN cuando la cotizaci√≥n est√° en USD
    const mxnEq = document.getElementById('mxnEq');
    if (mxnEq) {
      if (moneda === 'USD') {
        const tc = getTC();
        mxnEq.style.display = 'block';
        const tcInline = document.getElementById('tcInline');
        if (tcInline) tcInline.textContent = tc > 0 ? `${tc.toFixed(4)} MXN/USD` : '‚Äî';

        const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        if (tc > 0) {
          setText('mxnPrecio', fmtMXN(precio * tc));
          setText('mxnMensual', fmtMXN(pagoMensual * tc));
          setText('mxnTotal', fmtMXN(totalPagos * tc));
        } else {
          setText('mxnPrecio', '‚Äî');
          setText('mxnMensual', '‚Äî');
          setText('mxnTotal', '‚Äî');
        }
      } else {
        mxnEq.style.display = 'none';
      }
    }


    // Alerta si el usuario mete inputs incoherentes (upfront > precio)
    const alertBox = document.getElementById('alertInconsistencia');
    if ((apartado + enganche) > (precio + 0.01)) {
      alertBox.style.display = 'block';
      alertBox.innerHTML = `‚ö†Ô∏è <strong>Inconsistencia:</strong> Enganche + Apartado supera el precio. Ajusta el % de enganche o el apartado para evitar resultados enga√±osos.`;
    } else {
      alertBox.style.display = 'none';
      alertBox.textContent = '';
    }
  }

  function buildRow(n, fecha, balInicio, pago, interes, capital, balFin, special) {
    const tr = document.createElement('tr');
    if (special) tr.className = 'row-special';
    const fmtVal = (v) => v === '‚Äî' ? '‚Äî' : fmt(v);
    tr.innerHTML = `
      <td>${n}</td>
      <td>${fecha || '‚Äî'}</td>
      <td>${fmt(balInicio)}</td>
      <td>${fmt(pago)}</td>
      <td>${fmtVal(interes)}</td>
      <td>${fmt(capital)}</td>
      <td>${fmt(balFin)}</td>
    `;
    return tr;
  }

  function limpiar() {
    document.getElementById('nombreInversionista').value = '';
    const np = document.getElementById('nombreProyecto'); if (np) np.value = '';
    document.getElementById('nombreAsesor').value = '';

    document.getElementById('precio').value = 440000;
    document.getElementById('apartado').value = 5000;
    document.getElementById('tasaEnganche').value = 20;
    document.getElementById('tasaAnual').value = 0;
    document.getElementById('plazo').value = 20;
    document.getElementById('tasaComision').value = 2;

    initFechas();

    const tc = document.getElementById('tipoCambio');
    if (tc) tc.value = '';
    setTCStatus('');

    const m = document.getElementById('moneda');
    if (m) m.value = 'MXN';
    setMoneda('MXN');
  }

  function imprimirPDF() {
    if (isInAppBrowser()) {
      alert('Para imprimir/guardar PDF, abre este link en Safari/Chrome (opci√≥n ‚ÄúAbrir en navegador‚Äù). Los navegadores dentro de apps suelen bloquear la impresi√≥n.');
      return;
    }

    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
      || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPadOS

    const safeName = (s) => (s || '')
      .toString()
      .trim()
      .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-zA-Z0-9 ]/g, '')
      .replace(/\s+/g, '_')
      .slice(0, 60) || 'Sin_nombre';

    const inv = safeName(document.getElementById('nombreInversionista').value);
    const projEl = document.getElementById('nombreProyecto');
    const proj = safeName(projEl ? projEl.value : 'Proyecto');

    const oldTitle = document.title;
    document.title = `Cotizacion_LUNA_GrupoInmobiliario_${proj}_${inv}`;

    try {
      if (typeof window.print !== 'function') {
        throw new Error('print_not_supported');
      }
      window.print();
    } catch (e) {
      if (isIOS) {
        alert('Para guardar en PDF en iPhone/iPad: abre este cotizador en Safari y usa el bot√≥n Compartir ‚Üí Imprimir ‚Üí pellizca para PDF ‚Üí Compartir/Guardar.');
      } else {
        alert('La funci√≥n de impresi√≥n no est√° disponible en este navegador. Abre en Chrome/Edge y usa Imprimir/Guardar PDF.');
      }
    } finally {
      document.title = oldTitle;
    }
  }



  // Aviso si se abri√≥ dentro de una app (webview)
  (function(){
    const b = document.getElementById('inAppBanner');
    if (b && isInAppBrowser()) b.style.display = 'block';
  })();

  // init
  initFechas();
  formatMoney('precio');
  formatMoney('apartado');
  const mInit = document.getElementById('moneda');
  setMoneda(mInit ? mInit.value : 'MXN');
</script>
</body>
</html>
